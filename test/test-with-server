#!/bin/bash

# Test with Server Procedure
# Starts server, runs all tests, then stops server

set -e

echo "ðŸš€ Starting Test with Server Procedure..."
echo "========================================="

# Shared colors and logging
PROJECT_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
if [ -f "$PROJECT_ROOT/infrastructure/scripts/colors.sh" ]; then
    source "$PROJECT_ROOT/infrastructure/scripts/colors.sh"
fi

log_step() { echo -e "${BLUE}ðŸ”„ $1${NC}"; }

# Clean up any existing processes
log_step "Cleaning up existing processes..."
pkill -f "node.*server.js" 2>/dev/null || true
pkill -f "nodemon" 2>/dev/null || true
lsof -ti:35730 | xargs kill -9 2>/dev/null || true
lsof -ti:35729 | xargs kill -9 2>/dev/null || true
lsof -ti:8080 | xargs kill -9 2>/dev/null || true
sleep 2

# Start the development server in background
log_step "Starting development server..."
./dev > server.log 2>&1 &
DEV_PID=$!

# Wait for server to start
log_step "Waiting for server to initialize..."
sleep 5

# Check if server is running
if kill -0 $DEV_PID 2>/dev/null; then
    log_success "Server started successfully (PID: $DEV_PID)"
else
    echo "âŒ Server failed to start"
    cat server.log
    exit 1
fi

# Run the full test suite
log_step "Running full test suite..."
if npm test; then
    log_success "All tests completed!"
else
    echo "âŒ Some tests failed"
    TEST_EXIT_CODE=$?
fi

# Cleanup: Stop the server
log_step "Stopping development server..."
kill $DEV_PID 2>/dev/null || true
pkill -f "node.*server.js" 2>/dev/null || true
rm -f server.log

log_success "Test procedure completed"

# Exit with test result
exit ${TEST_EXIT_CODE:-0} 