#!/bin/bash

# Deploy Queb.Space - Production Deployment
# =========================================
# Deploys to Google Cloud Functions for queb.space

set -e

# Colors for output
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
RED='\033[0;31m'
NC='\033[0m'

log_info() {
    echo -e "${BLUE}‚ÑπÔ∏è  $1${NC}"
}

log_success() {
    echo -e "${GREEN}‚úÖ $1${NC}"
}

log_warning() {
    echo -e "${YELLOW}‚ö†Ô∏è  $1${NC}"
}

log_error() {
    echo -e "${RED}‚ùå $1${NC}"
}

# Get project root
PROJECT_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$PROJECT_ROOT"

echo "üöÄ Deploying Queb.Space to Production"
echo "====================================="
echo ""

# Check if .env exists
if [ ! -f ".env" ]; then
    log_error "No .env file found. Run ./setup-queb-space.sh first"
    exit 1
fi

# Load environment variables
export $(grep -v '^#' .env | xargs)

# Check if gcloud is installed
if ! command -v gcloud >/dev/null 2>&1; then
    log_error "Google Cloud SDK not found. Please install it first:"
    echo "   https://cloud.google.com/sdk/docs/install"
    exit 1
fi

# Check authentication
if ! gcloud auth list --filter=status:ACTIVE --format="value(account)" | grep -q .; then
    log_error "Not authenticated with Google Cloud. Please run:"
    echo "   gcloud auth login"
    exit 1
fi

# Check if project is set
CURRENT_PROJECT=$(gcloud config get-value project 2>/dev/null)
if [ "$CURRENT_PROJECT" != "molecular-analysis" ]; then
    log_info "Setting project to molecular-analysis..."
    gcloud config set project molecular-analysis
fi

# Check if OPENAI_API_KEY is set
if [ -z "$OPENAI_API_KEY" ]; then
    log_error "OPENAI_API_KEY not set in .env file"
    exit 1
fi

# Run pre-deployment tests
log_info "Running pre-deployment tests..."
if ! npm test -- --testPathPattern=unit.test.js --silent; then
    log_error "Unit tests failed"
    exit 1
fi

if ! npm test -- --testPathPattern=integration.test.js --silent; then
    log_error "Integration tests failed"
    exit 1
fi

log_success "All tests passed"

# Deploy to Google Cloud Functions
log_info "Deploying to Google Cloud Functions..."

gcloud functions deploy molecular-analysis \
    --gen2 \
    --runtime=nodejs20 \
    --region=us-central1 \
    --source=. \
    --entry-point=molecularAnalysis \
    --trigger-http \
    --allow-unauthenticated \
    --memory=1GB \
    --timeout=540s \
    --set-env-vars="OPENAI_API_KEY=$OPENAI_API_KEY,NODE_ENV=production" \
    --quiet

log_success "Function deployed successfully"

# Get function URL
FUNCTION_URL=$(gcloud functions describe molecular-analysis --region=us-central1 --format="value(serviceConfig.uri)")
log_success "Function URL: $FUNCTION_URL"

# Test the deployment
log_info "Testing deployment..."
if curl -s -f "$FUNCTION_URL" > /dev/null; then
    log_success "Deployment test successful"
else
    log_warning "Deployment test failed - function may still be starting up"
fi

# Check domain mapping
log_info "Checking domain mapping..."
if gcloud beta run domain-mappings describe --service=molecular-analysis --domain=queb.space --region=us-central1 --format="value(status)" 2>/dev/null; then
    log_success "Domain mapping: queb.space"
else
    log_warning "Domain mapping not found for queb.space"
fi

if gcloud beta run domain-mappings describe --service=molecular-analysis --domain=www.queb.space --region=us-central1 --format="value(status)" 2>/dev/null; then
    log_success "Domain mapping: www.queb.space"
else
    log_warning "Domain mapping not found for www.queb.space"
fi

echo ""
log_success "Deployment complete!"
echo ""
echo "üåê Production URLs:"
echo "   https://queb.space"
echo "   https://www.queb.space"
echo "   $FUNCTION_URL"
echo ""
echo "üìä Monitor:"
echo "   gcloud functions logs read molecular-analysis --region=us-central1"
echo "   gcloud functions describe molecular-analysis --region=us-central1" 