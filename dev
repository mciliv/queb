#!/bin/bash

# dev - Development server startup with Vite + Node.js backend

set -e

# Get project root
PROJECT_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$PROJECT_ROOT"

# Colors for output
source infrastructure/scripts/colors.sh

echo "ğŸš€ Starting Development Server"
echo "=============================="

# Clean up any existing processes
log_clean "Cleaning up development processes..."
./cleanup 2>/dev/null || true

# Run unit tests before starting development
log_info "ğŸ§ª Running unit tests..."
if npx jest --testPathPattern=unit.test.js --verbose --silent; then
    log_success "âœ… Unit tests passed!"
else
    log_error "âŒ Unit tests failed! Fix tests before continuing."
    exit 1
fi

# Check if dev.queb.space is in /etc/hosts
if ! grep -q "dev.queb.space" /etc/hosts; then
    log_warning "dev.queb.space not in /etc/hosts. Run ./setup-queb-space.sh first"
fi

log_info "Starting development servers..."
log_info "Press Ctrl+C to stop"
echo ""

# Start the Node.js backend server
log_info "ğŸ”§ Starting Node.js backend..."
PORT=3000 NODE_ENV=development npx nodemon --quiet backend/api/server.js &
BACKEND_PID=$!

# Wait for backend to start
sleep 3

# Check if backend is running
if kill -0 $BACKEND_PID 2>/dev/null; then
    log_success "âœ… Backend server is running!"
    
    echo ""
    log_success "ğŸŒ Development URL:"
    log_success "   ğŸŒŸ https://dev.queb.space"
    echo ""
    
    # Start Vite dev server for HMR only
    log_info "âš¡ Starting Vite for hot reloading..."
    npx vite --port 3001 &
    VITE_PID=$!
    
    # Store PIDs for cleanup
    echo $BACKEND_PID > /tmp/dev_backend_pid
    echo $VITE_PID > /tmp/dev_vite_pid
    
    log_success "âœ… Development servers ready!"
    log_info "   ğŸ“ Edit frontend files and see changes instantly"
    log_info "   ğŸ”„ Hot Module Replacement enabled on port 3001"
    log_info "   ğŸŒ Main app on port 3000"
    
    # Wait for either process to exit, then cleanup
    wait $BACKEND_PID $VITE_PID
    
    # Cleanup when either process exits
    log_info "ğŸ”„ Shutting down development servers..."
    kill $BACKEND_PID 2>/dev/null || true
    kill $VITE_PID 2>/dev/null || true
    
else
    log_error "âŒ Backend server failed to start"
    exit 1
fi
