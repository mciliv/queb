#!/bin/bash

# dev - Development server startup with comprehensive setup

set -e

# Get project root
PROJECT_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$PROJECT_ROOT"

# Colors for output
source infrastructure/scripts/colors.sh

echo "üöÄ Starting Development Server"
echo "=============================="

# Clean up any existing processes
log_clean "Cleaning up development processes..."
./cleanup 2>/dev/null || true

# Check if dev.queb.space is in /etc/hosts
if ! grep -q "dev.queb.space" /etc/hosts; then
    log_warning "dev.queb.space not in /etc/hosts. Run ./setup-queb-space.sh first"
fi

log_info "Starting development server..."
log_info "Press Ctrl+C to stop"
echo ""

# Start the server with standard dev ports
PORT=3000 NODE_ENV=development npx nodemon --quiet backend/api/server.js &
SERVER_PID=$!

# Wait for server to start
sleep 3

# Check if server is running
if kill -0 $SERVER_PID 2>/dev/null; then
    log_success "‚úÖ Server is running!"
    
    # Detect the actual HTTP port the server is using
    HTTP_PORT=$(lsof -i -P | grep "node.*LISTEN" | grep -v "3002\|3003" | head -1 | awk '{print $9}' | cut -d: -f2)
    
    if [ -z "$HTTP_PORT" ]; then
        HTTP_PORT="3000"  # fallback
    fi
    
    echo ""
    log_success "üåê Access URLs:"
    log_success "   Local: https://dev.queb.space"
    log_success "   HTTP:  http://localhost:$HTTP_PORT"
    log_success "   HTTPS: https://localhost:3001"
    echo ""
    
    # Start browser-sync for live reload
    if command -v browser-sync >/dev/null 2>&1; then
        log_info "üîÑ Starting browser-sync for live reload..."
        browser-sync start --proxy "localhost:$HTTP_PORT" --files "frontend/**/*" --port 3002 --no-notify &
        BROWSER_SYNC_PID=$!
        log_success "   Browser-sync: http://localhost:3002"
    else
        log_warning "Browser-sync not found. Install with: npm install -g browser-sync"
    fi
else
    log_error "‚ùå Server failed to start"
    exit 1
fi

# Wait for the main server process
wait $SERVER_PID
