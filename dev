#!/bin/bash
set -e

cmd="${1:-serve}"; shift || true

serve() {
  NODE_ENV=development node frontend/build-frontend.js --watch &
  FE=$!

  if node -e 'require.resolve("nodemon")' >/dev/null 2>&1; then
    node scripts/start-backend.js &
    BE=$!
  else
    PORT=3000 NODE_ENV=development bash scripts/start-backend.sh &
    BE=$!
  fi

  if [ "$1" != "-B" ] && [ "$1" != "--no-browser" ]; then
    FRONTEND_URL=http://localhost:3000 node frontend/dev-browser.js &
    DB=$!
  fi

  trap 'kill $FE $BE $DB 2>/dev/null || true' INT TERM
  wait $BE
}

build()  { node frontend/build-frontend.js "$@"; }
ship()   { node ship "$@"; }
commit() { ./commit "$@"; }
alias()  { echo "alias d='dev'" >> "${ZDOTDIR:-$HOME}/.zshrc"; echo "source ~/.zshrc"; }

case "$cmd" in
  serve) serve "$@" ;;
  build) build "$@" ;;
  ship)  ship  "$@" ;;
  commit) commit "$@" ;;
  alias) alias ;;
  -h|--help|help)
    echo "dev serve [--no-browser|-B]"; echo "dev build [--watch]"; echo "dev ship [args...]"; echo "dev commit [args...]"; echo "dev alias" ;;
  *) serve "$cmd" "$@" ;;
esac


