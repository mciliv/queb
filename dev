#!/bin/bash

# dev - Development server with auto-commit on exit

set -e

# Get project root
PROJECT_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$PROJECT_ROOT"

# Colors for output
source infrastructure/scripts/colors.sh

# Function to handle commit and push
commit_and_push() {
    ./commit
}

# Clean up any existing processes
./cleanup 2>/dev/null || true

# Run unified tests before starting development  
if ! NODE_OPTIONS="" node test/scripts/unified-test-runner.js; then
    log_error "❌ Tests failed!"
    exit 1
fi

# Trap to handle Ctrl+C and commit before exit
trap 'commit_and_push; kill $BACKEND_PID 2>/dev/null || true; exit 0' INT TERM

# Start the Node.js backend server
NODE_OPTIONS="" PORT=3000 NODE_ENV=development npx nodemon --quiet backend/api/server.js &
BACKEND_PID=$!

# Wait for backend to start
sleep 3

# Check if backend is running
if kill -0 $BACKEND_PID 2>/dev/null; then
    log_success "✅ http://localhost:3000 (Ctrl+C to stop & commit)"
    
    # Store PID for cleanup
    echo $BACKEND_PID > /tmp/dev_backend_pid
    
    # Wait for process to exit
    wait $BACKEND_PID
    
else
    log_error "❌ Backend server failed to start"
    exit 1
fi
