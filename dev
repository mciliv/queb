#!/bin/bash

# dev - Development server with auto-cleanup, restart, and auto-commit on exit

set -e

# Get project root
PROJECT_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$PROJECT_ROOT"

# Colors for output
source infrastructure/scripts/colors.sh

# Function to handle commit and push
commit_and_push() {
    ./commit
}

# Always clean up any existing processes first
log_info "üîÑ Cleaning up existing processes..."
./cleanup 2>/dev/null || true

# Wait a moment for cleanup to complete
sleep 1

# Parse flags
SKIP_DEV_BROWSER=${SKIP_DEV_BROWSER:-false}

# Test/visual modes
TEST_MODE=${DEV_TESTS:-watch}   # watch|startup|off
VISUAL_MODE=${DEV_VISUAL:-off}  # on|off
TEST_MODE_SET=false
QUICK_MODE=false

for arg in "$@"; do
  if [[ "$arg" == "--quick" || "$arg" == "-q" ]]; then
    QUICK_MODE=true
    log_info "‚ö° Quick mode"
  fi
  if [[ "$arg" == "--no-browser" || "$arg" == "-B" ]]; then
    SKIP_DEV_BROWSER=true
    log_info "üß© Using built-in browser: not launching external dev browser"
  fi
  if [[ "$arg" == --tests=* ]]; then
    TEST_MODE="${arg#--tests=}"
    TEST_MODE_SET=true
  fi
  if [[ "$arg" == "--tests-startup" ]]; then
    TEST_MODE=startup
    TEST_MODE_SET=true
  fi
  if [[ "$arg" == "--tests-watch" ]]; then
    TEST_MODE=watch
    TEST_MODE_SET=true
  fi
  if [[ "$arg" == "--tests-off" || "$arg" == "--no-tests" ]]; then
    TEST_MODE=off
    TEST_MODE_SET=true
  fi
  if [[ "$arg" == "--visual" ]]; then
    VISUAL_MODE=on
  fi
done

# If quick mode but no explicit tests preference, turn tests off
if [[ "$QUICK_MODE" == true && "$TEST_MODE_SET" == false ]]; then
  TEST_MODE=off
fi

# Tests handling (dev-only). Default: watch in background without blocking server
if [ "$TEST_MODE" = "off" ]; then
    log_info "‚è≠Ô∏è  Tests: off"
elif [ "$TEST_MODE" = "startup" ]; then
    log_info "üß™ Running tests (startup mode)..."
    if ! NODE_OPTIONS="" node test/scripts/unified-test-runner.js; then
        log_error "‚ùå Tests failed!"
        exit 1
    fi
    log_success "‚úÖ Tests passed"
else
    # watch mode
    log_info "üëÄ Tests: watch mode (non-blocking)"
    NODE_OPTIONS="" node test/watch/file-watcher.js &
    TEST_WATCHER_PID=$!
    echo $TEST_WATCHER_PID > /tmp/dev_watcher_pid
fi

# Trap to handle Ctrl+C and commit before exit
trap 'commit_and_push; kill $BACKEND_PID 2>/dev/null || true; kill $FRONTEND_PID 2>/dev/null || true; kill $DEV_BROWSER_PID 2>/dev/null || true; kill $TEST_WATCHER_PID 2>/dev/null || true; kill $VISUAL_WATCH_PID 2>/dev/null || true; exit 0' INT TERM

log_info "üöÄ Starting development server..."

# Start frontend watch build
log_info "üì¶ Starting frontend watcher..."
NODE_OPTIONS="" node scripts/build-frontend.js --watch &
FRONTEND_PID=$!

if [[ "$SKIP_DEV_BROWSER" != true ]]; then
  # Start dev browser manager (auto-close on changes, reopen on build complete)
  log_info "üåê Starting dev browser manager..."
  NODE_OPTIONS="" node scripts/dev-browser.js &
  DEV_BROWSER_PID=$!
fi

# Start the Node.js backend server with debugger
log_info "‚öôÔ∏è  Starting backend server with debugger..."
NODE_OPTIONS="" PORT=3000 NODE_ENV=development npx nodemon --quiet --exec "node --inspect=9229" backend/api/server.js &
BACKEND_PID=$!

# Wait for backend to start
sleep 3

# Check if backend is running
if kill -0 $BACKEND_PID 2>/dev/null; then
    log_success "‚úÖ Development server ready!"
    log_success "üåê Frontend: http://localhost:3000"
    log_success "üêõ Debug: VS Code auto-attach enabled"
    log_success "üîÑ Auto-refresh: Save files to trigger rebuilds"
    log_success "‚èπÔ∏è  Stop: Ctrl+C (auto-commits changes)"
    
    # Store PID for cleanup
    echo $BACKEND_PID > /tmp/dev_backend_pid
    
    # Optionally autorun visual tests once server is ready
    if [[ "$VISUAL_MODE" == on ]]; then
      log_info "üñºÔ∏è  Running visual tests..."
      # Default to dev HTTP port 3000 if not provided
      if [[ -z "$FRONTEND_URL" ]]; then
        export FRONTEND_URL="http://localhost:3000"
      fi
      NODE_OPTIONS="" FRONTEND_URL="$FRONTEND_URL" node test/scripts/test-visual-demo.js || true
      log_success "‚úÖ Visual tests triggered"

      # Start visual tests watch mode (non-blocking)
      log_info "üëÄ Visual tests: watch mode (non-blocking)"
      NODE_OPTIONS="" FRONTEND_URL="$FRONTEND_URL" npx nodemon \
        --quiet \
        --watch frontend \
        --watch backend \
        --watch test/scripts \
        --ext js,jsx,css,html \
        --exec "node test/scripts/test-visual-demo.js" &
      VISUAL_WATCH_PID=$!
    fi

    # Wait for process to exit
    wait $BACKEND_PID
    
else
    log_error "‚ùå Backend server failed to start"
    exit 1
fi
