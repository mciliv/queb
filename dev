#!/bin/bash

# dev - Development server with auto-cleanup, restart, and auto-commit on exit

set -e

# Get project root
PROJECT_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$PROJECT_ROOT"

# Colors for output
source infrastructure/scripts/colors.sh

# Function to handle commit and push
commit_and_push() {
    ./commit
}

# Always clean up any existing processes first
log_info "üîÑ Cleaning up existing processes..."
./cleanup 2>/dev/null || true

# Wait a moment for cleanup to complete
sleep 1

# Check for --quick flag to skip tests
SKIP_TESTS=false
if [[ "$1" == "--quick" || "$1" == "-q" ]]; then
    SKIP_TESTS=true
    log_info "‚ö° Quick mode: skipping tests"
fi

# Run unified tests before starting development (unless --quick)
if [ "$SKIP_TESTS" = false ]; then
    log_info "üß™ Running tests..."
    if ! NODE_OPTIONS="" node test/scripts/unified-test-runner.js; then
        log_error "‚ùå Tests failed!"
        exit 1
    fi
    log_success "‚úÖ Tests passed"
else
    log_info "‚è≠Ô∏è  Skipping tests (quick mode)"
fi

# Trap to handle Ctrl+C and commit before exit
trap 'commit_and_push; kill $BACKEND_PID 2>/dev/null || true; kill $FRONTEND_PID 2>/dev/null || true; kill $DEV_BROWSER_PID 2>/dev/null || true; exit 0' INT TERM

log_info "üöÄ Starting development server..."

# Start frontend watch build
log_info "üì¶ Starting frontend watcher..."
NODE_OPTIONS="" node scripts/build-frontend.js --watch &
FRONTEND_PID=$!

# Start dev browser manager (auto-close on changes, reopen on build complete)
log_info "üåê Starting dev browser manager..."
NODE_OPTIONS="" node scripts/dev-browser.js &
DEV_BROWSER_PID=$!

# Start the Node.js backend server with debugger
log_info "‚öôÔ∏è  Starting backend server with debugger..."
NODE_OPTIONS="" PORT=3000 NODE_ENV=development npx nodemon --quiet --exec "node --inspect=9229" backend/api/server.js &
BACKEND_PID=$!

# Wait for backend to start
sleep 3

# Check if backend is running
if kill -0 $BACKEND_PID 2>/dev/null; then
    log_success "‚úÖ Development server ready!"
    log_success "üåê Frontend: http://localhost:3000"
    log_success "üêõ Debug: VS Code auto-attach enabled"
    log_success "üîÑ Auto-refresh: Save files to trigger rebuilds"
    log_success "‚èπÔ∏è  Stop: Ctrl+C (auto-commits changes)"
    
    # Store PID for cleanup
    echo $BACKEND_PID > /tmp/dev_backend_pid
    
    # Wait for process to exit
    wait $BACKEND_PID
    
else
    log_error "‚ùå Backend server failed to start"
    exit 1
fi
