#!/bin/bash

# dev - Development server startup with Node.js backend serving frontend

set -e

# Get project root
PROJECT_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$PROJECT_ROOT"

# Colors for output
source infrastructure/scripts/colors.sh

echo "ğŸš€ Starting Development Server"
echo "=============================="

# Clean up any existing processes
log_clean "Cleaning up development processes..."
./cleanup 2>/dev/null || true

# Run unified tests before starting development  
log_info "ğŸ§ª Running comprehensive test suite..."
if node test/scripts/unified-test-runner.js; then
    log_success "âœ… All tests passed!"
else
    log_error "âŒ Tests failed! Fix issues before continuing."
    exit 1
fi

log_info "Starting development servers..."
log_info "Press Ctrl+C to stop"
echo ""

# Start the Node.js backend server
log_info "ğŸ”§ Starting Node.js backend..."
PORT=3000 NODE_ENV=development npx nodemon --quiet backend/api/server.js &
BACKEND_PID=$!

# Wait for backend to start
sleep 3

# Check if backend is running
if kill -0 $BACKEND_PID 2>/dev/null; then
    log_success "âœ… Backend server is running!"
    
    echo ""
    log_success "ğŸŒ Development URLs:"
    log_success "   http://localhost:3000"
    log_success "   https://localhost:3002"
    echo ""
    
    # Store PID for cleanup
    echo $BACKEND_PID > /tmp/dev_backend_pid
    
    log_success "âœ… Development server ready!"
    log_info "   ğŸ“ Edit frontend files - restart server to see changes"
    log_info "   ğŸŒ Single server serves everything on port 3000"
    
    # Wait for process to exit, then cleanup
    wait $BACKEND_PID
    
    # Cleanup when process exits
    log_info "ğŸ”„ Shutting down development server..."
    kill $BACKEND_PID 2>/dev/null || true
    
else
    log_error "âŒ Backend server failed to start"
    exit 1
fi
