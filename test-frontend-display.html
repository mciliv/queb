<!DOCTYPE html>
<html>
<head>
    <title>Frontend SDF Display Test</title>
    <script src="https://3dmol.csb.pitt.edu/build/3Dmol-min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
        .molecule-viewer { width: 300px; height: 300px; border: 1px solid #ccc; }
        .success { color: green; font-weight: bold; }
        .error { color: red; font-weight: bold; }
        .info { color: blue; }
    </style>
</head>
<body>
    <h1>Frontend SDF Display Test</h1>
    
    <div class="test-section">
        <h3>Test 1: Direct SDF Loading</h3>
        <div id="direct-test">
            <div class="molecule-viewer"></div>
            <div id="direct-status"></div>
        </div>
    </div>

    <div class="test-section">
        <h3>Test 2: API Generation + Display</h3>
        <button onclick="testAPIGeneration()">Generate and Display CCO</button>
        <div id="api-test"></div>
    </div>

    <div class="test-section">
        <h3>Test 3: Multiple Molecules</h3>
        <button onclick="testMultipleMolecules()">Generate Multiple Molecules</button>
        <div id="multiple-test"></div>
    </div>

    <script>
        // Simplified render function from app.js
        async function render(sdfFile, container) {
            try {
                console.log(`Rendering SDF: ${sdfFile}`);
                const response = await fetch(sdfFile);
                if (!response.ok) {
                    throw new Error(`HTTP error ${response.status}`);
                }

                const sdfData = await response.text();
                console.log(`SDF data length: ${sdfData.length} characters`);
                
                const viewer = $3Dmol.createViewer(container, {
                    defaultcolors: $3Dmol.rasmolElementColors,
                });

                viewer.addModel(sdfData, "sdf");
                // CRITICAL: Use ONLY sphere representation with van der Waals radii at 0.8 scale
                viewer.setStyle({}, { sphere: { scale: 0.8 } });
                viewer.zoomTo();
                viewer.render();

                console.log('Molecule rendered successfully');
                return viewer;
                
            } catch (error) {
                console.error(`Failed to load molecule:`, error);
                container.textContent = `Error loading molecule: ${error.message}`;
                container.className += " error-text";
                return null;
            }
        }

        // Test 1: Direct SDF Loading
        async function testDirectLoading() {
            const container = document.querySelector('#direct-test .molecule-viewer');
            const status = document.getElementById('direct-status');
            
            try {
                const viewer = await render('/sdf_files/CCO.sdf', container);
                if (viewer) {
                    status.innerHTML = '<span class="success">✓ Direct SDF loading successful</span>';
                } else {
                    status.innerHTML = '<span class="error">✗ Direct SDF loading failed</span>';
                }
            } catch (error) {
                status.innerHTML = `<span class="error">✗ Error: ${error.message}</span>`;
            }
        }

        // Test 2: API Generation + Display
        async function testAPIGeneration() {
            const container = document.getElementById('api-test');
            container.innerHTML = '<div class="info">Generating SDF via API...</div>';
            
            try {
                // Generate SDF
                const response = await fetch("/generate-sdfs", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ smiles: ["CCO"] }),
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log('API result:', result);
                    
                    if (result.sdfPaths && result.sdfPaths.length > 0) {
                        container.innerHTML = '<div class="molecule-viewer"></div>';
                        const viewer = await render(result.sdfPaths[0], container.querySelector('.molecule-viewer'));
                        
                        if (viewer) {
                            container.innerHTML += '<div class="success">✓ API generation and display successful</div>';
                        } else {
                            container.innerHTML += '<div class="error">✗ Display failed after successful generation</div>';
                        }
                    } else {
                        container.innerHTML = `<div class="error">✗ No SDF paths returned: ${JSON.stringify(result)}</div>`;
                    }
                } else {
                    container.innerHTML = `<div class="error">✗ API failed: ${response.status} ${response.statusText}</div>`;
                }
            } catch (error) {
                container.innerHTML = `<div class="error">✗ Error: ${error.message}</div>`;
            }
        }

        // Test 3: Multiple Molecules
        async function testMultipleMolecules() {
            const container = document.getElementById('multiple-test');
            container.innerHTML = '<div class="info">Generating multiple molecules...</div>';
            
            try {
                const chemicals = [
                    { smiles: 'CCO', name: 'Ethanol' },
                    { smiles: 'O', name: 'Water' },
                    { smiles: 'C1=CC=CC=C1', name: 'Benzene' }
                ];
                
                // Generate SDFs
                const sdfResult = await generateSDFs(chemicals);
                console.log('SDF result:', sdfResult);
                
                if (sdfResult.sdfFiles.length > 0) {
                    container.innerHTML = '<div class="info">Rendering molecules...</div>';
                    
                    // Create containers for each molecule
                    for (let i = 0; i < sdfResult.sdfFiles.length; i++) {
                        const moleculeDiv = document.createElement('div');
                        moleculeDiv.style.margin = '10px 0';
                        moleculeDiv.innerHTML = `
                            <div class="info">${chemicals[i].name} (${chemicals[i].smiles})</div>
                            <div class="molecule-viewer"></div>
                        `;
                        container.appendChild(moleculeDiv);
                        
                        // Render the molecule
                        await render(sdfResult.sdfFiles[i], moleculeDiv.querySelector('.molecule-viewer'));
                    }
                    
                    container.innerHTML += '<div class="success">✓ Multiple molecules rendered successfully</div>';
                } else {
                    container.innerHTML = `<div class="error">✗ No SDF files generated</div>`;
                }
            } catch (error) {
                container.innerHTML = `<div class="error">✗ Error: ${error.message}</div>`;
            }
        }

        // Simplified generateSDFs function from app.js
        async function generateSDFs(chemicals) {
            const sdfFiles = [];
            const smiles = [];

            // Collect all SMILES strings
            const smilesArray = chemicals
                .filter(chemical => chemical.smiles)
                .map(chemical => chemical.smiles);

            if (smilesArray.length === 0) {
                return { sdfFiles, smiles };
            }

            try {
                const response = await fetch("/generate-sdfs", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ smiles: smilesArray }),
                });

                if (response.ok) {
                    const result = await response.json();
                    
                    if (result.sdfPaths && Array.isArray(result.sdfPaths)) {
                        // Convert relative paths to full URLs
                        for (const sdfPath of result.sdfPaths) {
                            const fullUrl = sdfPath.startsWith('/') ? sdfPath : `/${sdfPath}`;
                            sdfFiles.push(fullUrl);
                        }
                        
                        // Add corresponding SMILES
                        for (let i = 0; i < result.sdfPaths.length && i < smilesArray.length; i++) {
                            smiles.push(smilesArray[i]);
                        }
                    }
                    
                    if (result.errors && result.errors.length > 0) {
                        console.warn('SDF generation errors:', result.errors);
                    }
                } else {
                    console.warn(`Failed to generate SDFs: ${response.status} ${response.statusText}`);
                }
            } catch (error) {
                console.error(`Error generating SDFs:`, error);
            }

            return { sdfFiles, smiles };
        }

        // Run direct test on page load
        document.addEventListener('DOMContentLoaded', testDirectLoading);
    </script>
</body>
</html> 