<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Molecular Space Analyzer</title>
    <link rel="stylesheet" href="assets/style.css">
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback, createContext, useContext } = React;
        
        // Payment configuration
        const PAYMENT_CONFIG = {
            enabled: false,
            devMode: location.hostname === 'dev.queb.space' || location.hostname === 'localhost'
        };

        // API hook
        const useApi = () => {
            const [error, setError] = useState('');

            const analyzeText = async (text) => {
                const response = await fetch('/analyze-text', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ object: text })
                });
                if (!response.ok) throw new Error(`API Error: ${response.status}`);
                return await response.json();
            };

            const analyzeImage = async (imageData, filename) => {
                const response = await fetch('/image-molecules', {
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ imageBase64: imageData })
                });
                if (!response.ok) throw new Error(`API Error: ${response.status}`);
                return await response.json();
            };

            const generateSDFs = async (smiles, overwrite = false) => {
                const response = await fetch('/generate-sdfs', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ smiles, overwrite })
                });
                if (!response.ok) throw new Error(`SDF Error: ${response.status}`);
                return await response.json();
            };

            const testConnection = async () => {
                try {
                    const response = await fetch('/');
                    return response.ok;
                } catch { return false; }
            };

            return { analyzeText, analyzeImage, generateSDFs, testConnection, error };
        };

        // Payment Context
        const PaymentContext = createContext();

        const usePayment = () => {
            const context = useContext(PaymentContext);
            if (!context) throw new Error('usePayment must be used within PaymentProvider');
            return context;
        };

        const PaymentProvider = ({ children }) => {
            const [isPaymentSetup, setIsPaymentSetup] = useState(!PAYMENT_CONFIG.enabled);

            const checkPaymentRequired = () => {
                return PAYMENT_CONFIG.enabled && !isPaymentSetup && !PAYMENT_CONFIG.devMode;
            };

            return (
                <PaymentContext.Provider value={{ 
                    isPaymentSetup, 
                    setIsPaymentSetup, 
                    checkPaymentRequired,
                    config: PAYMENT_CONFIG 
                }}>
                    {children}
                </PaymentContext.Provider>
            );
        };

        // Main App Component
        const MolecularSpaceAnalyzer = () => {
            const [objectInput, setObjectInput] = useState('');
            const [isProcessing, setIsProcessing] = useState(false);
            const [viewers, setViewers] = useState([]);
            const [error, setError] = useState('');
            const [currentAnalysisType, setCurrentAnalysisType] = useState(null);
            const [lastAnalysis, setLastAnalysis] = useState(null);
            
            const { analyzeText, generateSDFs } = useApi();
            const { checkPaymentRequired } = usePayment();

            const handleTextAnalysis = async (value) => {
                if (isProcessing || !value.trim()) return;
                if (checkPaymentRequired()) return;

                setIsProcessing(true);
                setCurrentAnalysisType('text');
                setError('');

                try {
                    const result = await analyzeText(value);
                    const molecules = result.molecules || result.chemicals || [];
                    
                    if (molecules.length > 0) {
                        const smilesArray = molecules.map(mol => mol.smiles).filter(Boolean);
                        
                        if (smilesArray.length > 0) {
                            const sdfResult = await generateSDFs(smilesArray, false);
                            const newViewers = molecules.map((mol, index) => ({
                                name: mol.name || value,
                                sdfData: sdfResult.sdfPaths?.[index] ? `file://${sdfResult.sdfPaths[index]}` : null,
                                smiles: mol.smiles
                            }));
                            setViewers(newViewers);
                        }
                    } else {
                        setError('No molecules found for this input.');
                    }
                    
                    setLastAnalysis(result);
                    setObjectInput('');
                } catch (error) {
                    setError(`Analysis failed: ${error.message}`);
                } finally {
                    setIsProcessing(false);
                }
            };

            return (
                <div className="app-container">
                    <div className="main-app-interface">
                        <div className="main-content-layout">
                            <div className="analysis-section">
                                <div className="top-bar">
                                    <div className="input-container">
                                        <input
                                            type="text"
                                            placeholder="Specify an object or molecule (e.g., 'water', 'aspirin', 'CCO')..."
                                            className="text-input"
                                            value={objectInput}
                                            onChange={(e) => setObjectInput(e.target.value)}
                                            onKeyDown={(e) => {
                                                if (e.key === 'Enter' && !isProcessing) {
                                                    e.preventDefault();
                                                    handleTextAnalysis(objectInput);
                                                }
                                            }}
                                            disabled={isProcessing}
                                        />
                                    </div>
                                    {error && <div className="input-error">{error}</div>}
                                    {isProcessing && (
                                        <div className="processing-indicator">
                                            <span className="spinner"></span>
                                            Analyzing...
                                        </div>
                                    )}
                                </div>
                                
                                <div id="gldiv" className="molecular-gridviewer-container">
                                    {viewers.map((viewer, index) => (
                                        <div key={index} className="object-column">
                                            <div className="object-title">
                                                <span>{viewer.name}</span>
                                                <button 
                                                    className="close-button"
                                                    onClick={() => setViewers(prev => prev.filter((_, i) => i !== index))}
                                                >
                                                    âœ•
                                                </button>
                                            </div>
                                            <div className="mol-viewer-container">
                                                {viewer.smiles && (
                                                    <div className="smiles-fallback">
                                                        SMILES: <code>{viewer.smiles}</code>
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // Root App
        const App = () => (
            <PaymentProvider>
                <MolecularSpaceAnalyzer />
            </PaymentProvider>
        );

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>