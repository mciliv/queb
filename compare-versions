#!/bin/bash

# Version comparison script with diff generation
# Usage: ./compare-versions <version1> <version2> [test-cases...]

if [ $# -lt 2 ]; then
    echo "Usage: ./compare-versions <version1> <version2> [test-cases...]"
    echo ""
    echo "Examples:"
    echo "  ./compare-versions main v1.2.3"
    echo "  ./compare-versions baseline feature-xyz water ethanol"
    echo "  ./compare-versions current previous"
    echo ""
    echo "Available versions:"
    node -e "
    const VersionRegistry = require('./test/support/version-registry');
    const registry = new VersionRegistry();
    const versions = registry.listVersions();
    versions.forEach(v => console.log('  ' + v.name + ' (' + v.commit + ')'));
    "
    exit 1
fi

VERSION1="$1"
VERSION2="$2"
shift 2
TEST_CASES="$@"

echo "ğŸ”¬ Comparing versions: $VERSION1 vs $VERSION2"
if [ ! -z "$TEST_CASES" ]; then
    echo "ğŸ§ª Test cases: $TEST_CASES"
fi
echo ""

# Run comparison
node -e "
const VersionComparator = require('./test/utils/version-comparator');
const comparator = new VersionComparator();

async function runComparison() {
    try {
        const testCases = '$TEST_CASES'.split(' ').filter(Boolean);
        const defaultCases = ['water', 'ethanol', 'caffeine'];
        const finalTestCases = testCases.length > 0 ? testCases : defaultCases;
        
        console.log('ğŸš€ Starting comparison...');
        const results = await comparator.compareVersions('$VERSION1', '$VERSION2', finalTestCases);
        
        console.log('');
        console.log('ğŸ“Š Quick Summary:');
        console.log('  Total differences:', results.summary.totalDifferences);
        console.log('  Improvements:', results.summary.improvements);
        console.log('  Regressions:', results.summary.regressions);
        console.log('  Overall trend:', results.summary.overallTrend);
        console.log('');
        
        console.log('ğŸ’¡ Detailed report generated in test/results/');
        
    } catch (error) {
        console.error('âŒ Comparison failed:', error.message);
        process.exit(1);
    } finally {
        await comparator.manager.cleanup();
    }
}

runComparison();
"
