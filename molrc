#!/bin/bash

# Molecular Project Script Runner
# Reads .molrc configuration and executes defined scripts

MOLRC_FILE=".rc"
COMMAND="$1"
shift  # Remove command from args

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Function to read script from .rc
get_script() {
    local script_name="$1"
    # Extract script command from [scripts] section
    awk -v script="$script_name" '
        /^\[scripts\]/ { in_scripts=1; next }
        /^\[/ { in_scripts=0; next }
        in_scripts && $0 ~ "^" script " = " { 
            gsub(/^[^=]*= *"?/, ""); 
            gsub(/"$/, ""); 
            print; 
            exit 
        }
    ' "$MOLRC_FILE"
}

# Function to list all available scripts
list_scripts() {
    echo -e "${BLUE}üìã Available scripts in .rc:${NC}"
    echo ""
    
    awk '
        /^\[scripts\]/ { in_scripts=1; print "Development:"; next }
        /^\[/ { in_scripts=0; next }
        in_scripts && /^[a-zA-Z]/ && /=/ {
            split($0, parts, " = ");
            name = parts[1];
            cmd = parts[2];
            gsub(/"/, "", cmd);
            
            # Categorize scripts
            if (name ~ /^test/) category = "Testing";
            else if (name ~ /(build|browser)/) category = "Frontend";
            else if (name ~ /(format|clean|deploy|setup|cert)/) category = "Utilities";
            else if (name ~ /(dev|server|debug)/) category = "Development";
            else category = "Other";
            
            if (category != last_category) {
                if (last_category != "") print "";
                print category ":";
                last_category = category;
            }
            
            printf "  %-15s - %s\n", name, (length(cmd) > 50 ? substr(cmd, 1, 50) "..." : cmd);
        }
    ' "$MOLRC_FILE"
}

# Function to show project info
show_info() {
    echo -e "${GREEN}üß¨ Molecular Space Analyzer${NC}"
    echo ""
    echo -e "${BLUE}Project Configuration (.rc):${NC}"
    
    # Extract project info
    name=$(awk '/^\[project\]/{f=1} f && /^name/{gsub(/.*= *"?/, ""); gsub(/"$/, ""); print; exit}' "$MOLRC_FILE")
    version=$(awk '/^\[project\]/{f=1} f && /^version/{gsub(/.*= *"?/, ""); gsub(/"$/, ""); print; exit}' "$MOLRC_FILE")
    
    echo "  Name: $name"
    echo "  Version: $version"
    echo ""
    
    # Show paths
    echo -e "${BLUE}Directory Structure:${NC}"
    awk '/^\[paths\]/{f=1; next} /^\[/{f=0} f && /=/ {
        gsub(/ = /, " ‚Üí "); 
        gsub(/"/, ""); 
        print "  " $0
    }' "$MOLRC_FILE"
}

# Main logic
case "$COMMAND" in
    "")
        show_info
        echo ""
        list_scripts
        ;;
    "list"|"ls")
        list_scripts
        ;;
    "info")
        show_info
        ;;
    "edit")
        ${EDITOR:-nano} "$MOLRC_FILE"
        ;;
    *)
        # Try to run the script
        script_cmd=$(get_script "$COMMAND")
        
        if [ -n "$script_cmd" ]; then
            echo -e "${GREEN}üöÄ Running: $COMMAND${NC}"
            echo -e "${YELLOW}Command: $script_cmd${NC}"
            echo ""
            
            # Execute the script with any additional args
            eval "$script_cmd $*"
        else
            echo -e "${RED}‚ùå Script '$COMMAND' not found in .rc${NC}"
            echo ""
            echo "Available scripts:"
            list_scripts
            exit 1
        fi
        ;;
esac
