#!/bin/bash

# Load shared colors and logging functions
source infrastructure/scripts/colors.sh

log_clean "Cleaning up development: processes, ports, temp files, and test profiles"

# Counters
TOTAL_KILLED=0
PORTS_FREED=0
FILES_REMOVED=0
DIRS_REMOVED=0

# Make unmatched globs expand to nothing (not literal)
if command -v shopt >/dev/null 2>&1; then
  shopt -s nullglob >/dev/null 2>&1 || true
fi

kill_pattern() {
  local pattern="$1"
  local label="$2"
  local pids
  pids=$(pgrep -f "$pattern" 2>/dev/null || true)
  if [ -n "$pids" ]; then
    log_info "üî™ $label (pattern: $pattern) PIDs: $(echo "$pids" | tr '\n' ' ')"
    echo "$pids" | xargs kill 2>/dev/null || true
    sleep 0.1
    echo "$pids" | xargs kill -9 2>/dev/null || true
    local count
    count=$(echo "$pids" | wc -w | tr -d ' ')
    TOTAL_KILLED=$((TOTAL_KILLED + count))
  else
    log_info "‚úÖ No $label running"
  fi
}

kill_pattern "node.*backend/api/server.js" "Node backend servers"
kill_pattern "nodemon.*backend/api/server.js" "Nodemon (backend)"
kill_pattern "npm.*nodemon" "npm-driven nodemon"
kill_pattern "nodemon" "Residual nodemon"
kill_pattern "backend/api/server.js" "Backend server scripts"

# Kill stale Chrome instances holding Puppeteer profiles
kill_pattern "Google Chrome.*chrome-molecular-profile" "Google Chrome (dev profiles)"
kill_pattern "chrome.*chrome-molecular-profile" "Chrome (dev profiles)"

# Kill our file watcher processes (legacy)
if [ -f /tmp/dev_watcher_pid ]; then
    WATCHER_PID=$(cat /tmp/dev_watcher_pid)
    log_info "üî™ File watcher PID: $WATCHER_PID"
    kill $WATCHER_PID 2>/dev/null || true
    rm -f /tmp/dev_watcher_pid
    FILES_REMOVED=$((FILES_REMOVED + 1))
fi

# Kill dev browser manager if running
if [ -f /tmp/dev_browser_pid ]; then
    B_PID=$(cat /tmp/dev_browser_pid)
    log_info "üî™ Dev browser PID: $B_PID"
    kill $B_PID 2>/dev/null || true
    rm -f /tmp/dev_browser_pid
    FILES_REMOVED=$((FILES_REMOVED + 1))
fi

# Kill our reload server (legacy)
if [ -f /tmp/dev_reload_pid ]; then
    RELOAD_PID=$(cat /tmp/dev_reload_pid)
    log_info "üî™ Reload server PID: $RELOAD_PID"
    kill $RELOAD_PID 2>/dev/null || true
    rm -f /tmp/dev_reload_pid
    FILES_REMOVED=$((FILES_REMOVED + 1))
fi

# Kill any fswatch processes (legacy)
pkill -f "fswatch" 2>/dev/null || true

# Try to free up the common ports
if command -v lsof >/dev/null 2>&1; then
  for port in 3000 3001 3002 3004; do
    pids=$(lsof -ti:$port 2>/dev/null || true)
    if [ ! -z "$pids" ]; then
      log_info "üßπ Freeing port $port (PIDs: $pids)"
      echo "$pids" | xargs kill -9 2>/dev/null || true
      PORTS_FREED=$((PORTS_FREED + 1))
    fi
  done
fi

# Clean up temp files
for f in /tmp/dev_backend_pid /tmp/dev_server_pid /tmp/frontend_last_check; do
  if [ -f "$f" ]; then
    rm -f "$f"
    FILES_REMOVED=$((FILES_REMOVED + 1))
    log_info "üóëÔ∏è Removed $f"
  fi
done

# Remove temporary Chrome user data directories created by helpers
ROOT_DIR="$(cd "$(dirname "$0")" && pwd)"
TEST_DIR="$ROOT_DIR/test"
if [ -d "$TEST_DIR" ]; then
  for d in "$TEST_DIR"/chrome-molecular-profile-* "$TEST_DIR"/seamless-chrome-profile "$TEST_DIR"/single-tab-chrome; do
    if [ -e "$d" ]; then
      rm -rf "$d" 2>/dev/null || true
      DIRS_REMOVED=$((DIRS_REMOVED + 1))
      log_info "üóëÔ∏è Removed dir: $d"
    fi
  done
  # Remove stale Puppeteer lock files if any remain
  if command -v find >/dev/null 2>&1; then
    LOCKS=$(find "$TEST_DIR" -name "SingletonLock" -type f 2>/dev/null || true)
    if [ -n "$LOCKS" ]; then
      echo "$LOCKS" | while read -r f; do
        rm -f "$f" 2>/dev/null || true
        FILES_REMOVED=$((FILES_REMOVED + 1))
        log_info "üóëÔ∏è Removed lock: $f"
      done
    fi
  fi
fi

# Wait a moment for processes to fully terminate
sleep 1

log_success "Cleanup complete (stopped ${TOTAL_KILLED} processes, freed ${PORTS_FREED} ports, removed ${FILES_REMOVED} files, ${DIRS_REMOVED} dirs)."
log_success "You can now restart the server." 