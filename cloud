#!/usr/bin/env node

const { execSync } = require("child_process");
try { require("dotenv").config(); } catch (_) {}
if (!process.env.OPENAI_API_KEY && process.env.OPEN_API_KEY) {
  process.env.OPENAI_API_KEY = process.env.OPEN_API_KEY;
}

const config = {
  functionName: "molecular-analysis",
  runtime: "nodejs20",
  region: "us-central1",
  memory: "1GB",
  timeout: "540s",
  entryPoint: "molecularAnalysis",
};

if (!process.env.OPENAI_API_KEY) {
  console.error("OPENAI_API_KEY required");
  process.exit(1);
}

try {
  try { execSync("gcloud --version", { stdio: "ignore" }); } catch (_) {
    console.error("gcloud not installed");
    process.exit(1);
  }
  const active = execSync("gcloud auth list --filter=status:ACTIVE --format=\"value(account)\"", { encoding: "utf8" }).trim();
  if (!active) {
    console.error("gcloud not authenticated");
    process.exit(1);
  }

  execSync("./test/test-run", { stdio: "inherit" });

  const deployCommand = [
    "gcloud functions deploy",
    config.functionName,
    "--gen2",
    `--runtime ${config.runtime}`,
    "--trigger-http",
    "--allow-unauthenticated",
    `--memory ${config.memory}`,
    `--timeout ${config.timeout}`,
    `--region ${config.region}`,
    `--entry-point ${config.entryPoint}`,
    "--source .",
    `--set-env-vars OPENAI_API_KEY=${process.env.OPENAI_API_KEY},NODE_ENV=production`,
    "--quiet",
  ].join(" ");
  execSync(deployCommand, { stdio: "inherit" });
} catch (error) {
  console.error(error && error.stack ? error.stack : String(error));
  process.exit(1);
}
