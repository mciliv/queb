#!/bin/bash

# Exit on any error
set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Function to print colored output
print_status() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

print_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# Get script directory and project root
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
RUN_SCRIPT="$PROJECT_ROOT/run"

# Function to setup aliases
setup_mol_aliases() {
    # Validate paths
    if [[ ! -f "$RUN_SCRIPT" ]]; then
        print_error "Run script not found at: $RUN_SCRIPT"
        return 1
    fi

    if [[ ! -d "$PROJECT_ROOT" ]]; then
        print_error "Project root not found at: $PROJECT_ROOT"
        return 1
    fi

    # Determine RC file
    RC_FILE=~/.zshrc
    if [[ -f ~/.bashrc ]] && [[ ! -f ~/.zshrc ]]; then
        RC_FILE=~/.bashrc
        print_warning "Using ~/.bashrc instead of ~/.zshrc"
    fi

    # Create backup
    BACKUP_FILE="${RC_FILE}.bak.$(date +%Y%m%d_%H%M%S)"
    cp "$RC_FILE" "$BACKUP_FILE"
    print_status "Created backup: $BACKUP_FILE"

    # Remove existing mol aliases section
    if grep -q "# mol aliases" "$RC_FILE"; then
        sed -i.bak '/# mol aliases/,/# end mol aliases/d' "$RC_FILE"
        print_status "Removed existing mol aliases"
    fi

    # Add new aliases
    cat >> "$RC_FILE" << 'EOF'

# mol aliases - Auto-generated by setup-aliases.sh
MOL_RUN="PLACEHOLDER_RUN_SCRIPT"
alias dev="$MOL_RUN dev"
alias test="$MOL_RUN test"
alias deploy="$MOL_RUN deploy"
alias format="$MOL_RUN format"
alias server="$MOL_RUN server"
alias debug="$MOL_RUN debug"
alias unit="$MOL_RUN unit"
alias integration="$MOL_RUN integration"
alias system="$MOL_RUN system"
alias watch="$MOL_RUN watch"
alias pytest="$MOL_RUN pytest"
alias ship="$MOL_RUN ship"
alias ip="$MOL_RUN ip"
alias mobile="$MOL_RUN mobile"
alias cert="$MOL_RUN cert"
alias commit="$MOL_RUN commit"
# end mol aliases
EOF
    
    # Replace placeholder with actual path
    sed -i.tmp "s|PLACEHOLDER_RUN_SCRIPT|$RUN_SCRIPT|g" "$RC_FILE"
    rm -f "$RC_FILE.tmp"

    print_status "Aliases added to $RC_FILE"
    print_status "Project root: $PROJECT_ROOT"
    print_status "Run script: $RUN_SCRIPT"
    print_status "Run 'source $RC_FILE' to reload aliases"
}

# Only run setup if script is executed directly (not sourced)
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    setup_mol_aliases
fi 
