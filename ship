#!/usr/bin/env node

const { execSync } = require("child_process");

console.log("üö¢ Starting complete workflow (ship)...");

// Configuration
const config = {
  functionName: "molecular-analysis",
  runtime: "nodejs20",
  region: "us-central1",
  memory: "1GB",
  timeout: "540s",
  entryPoint: "molecularAnalysis",
};

// Pretty error with clickable source location
function printErrorWithLocation(message) {
  const err = new Error(message);
  const stack = (err.stack || '').split('\n').map(s => s.trim());
  // Second line usually contains the caller location
  const top = stack[1] || '';
  // Try to extract file:line:column
  const m = top.match(/\((.*):(\d+):(\d+)\)/) || top.match(/at (.*):(\d+):(\d+)/);
  if (m) {
    const file = m[1];
    const line = m[2];
    const col = m[3];
    console.error(`‚ùå ${file}:${line}:${col} - ${message}`);
  } else {
    console.error(`‚ùå ${message}`);
    if (stack.length > 1) console.error(stack.slice(1).join('\n'));
  }
}

// Check for required environment variable
if (!process.env.OPENAI_API_KEY) {
  printErrorWithLocation("OPENAI_API_KEY environment variable is required");
  process.exit(1);
}

try {
  // Step 1: Stage all changes
  console.log("üìù Staging all changes...");
  execSync("git add .", { stdio: "inherit" });

  // Step 2: Commit with timestamp
  const timestamp = new Date().toLocaleString();
  const commitMessage = `Auto-commit before production deployment - ${timestamp}`;
  console.log("üíæ Committing changes...");
  execSync(`git commit -m "${commitMessage}"`, { stdio: "inherit" });

  // Step 3: Run pre-deployment tests
  console.log("üß™ Running pre-deployment tests...");
  execSync("npm run test:pre-deploy", { stdio: "inherit" });

  // Step 4: Deploy to Google Cloud Functions
  console.log("‚òÅÔ∏è  Deploying to Google Cloud Functions...");
  
  const deployCommand = [
    "gcloud functions deploy",
    config.functionName,
    "--gen2",
    `--runtime ${config.runtime}`,
    "--trigger-http",
    "--allow-unauthenticated",
    `--memory ${config.memory}`,
    `--timeout ${config.timeout}`,
    `--region ${config.region}`,
    `--entry-point ${config.entryPoint}`,
    "--source .",
    `--set-env-vars OPENAI_API_KEY=${process.env.OPENAI_API_KEY}`,
    "--quiet"
  ].join(" ");

  execSync(deployCommand, { stdio: "inherit" });

  // Step 5: Push to git repository
  console.log("üì§ Pushing to git repository...");
  execSync("git push", { stdio: "inherit" });

  console.log("‚úÖ Complete workflow successful!");
  console.log("üåê Function deployed to Google Cloud Functions");

} catch (error) {
  const stack = error && error.stack ? error.stack : '';
  if (stack) {
    // Print stack so terminals show a clickable link to the failing location
    console.error(stack);
  } else {
    console.error("‚ùå Workflow failed:", error.message);
  }
  process.exit(1);
}
