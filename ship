#!/bin/bash

# Load shared colors and logging functions
source infrastructure/scripts/colors.sh

log_ship "Starting complete workflow (ship)..."

# Check for required environment variable
if [ -z "$OPENAI_API_KEY" ]; then
  log_error "OPENAI_API_KEY environment variable is required"
  exit 1
fi

# Stage all changes
log_info "ğŸ“ Staging all changes..."
git add .

# Commit with timestamp
timestamp=$(date)
commit_message="Auto-commit before production deployment - $timestamp"
log_info "ğŸ’¾ Committing changes..."
git commit -m "$commit_message"

# Run pre-deployment tests
log_test "Running pre-deployment tests..."
./test

if [ $? -ne 0 ]; then
  log_error "Tests failed - aborting deployment"
  exit 1
fi

# Deploy to Google Cloud Functions
log_info "â˜ï¸  Deploying to Google Cloud Functions..."
gcloud functions deploy molecular-analysis --gen2 --runtime nodejs20 --trigger-http --allow-unauthenticated --memory 1GB --timeout 540s --region us-central1 --entry-point molecularAnalysis --source . --set-env-vars OPENAI_API_KEY=$OPENAI_API_KEY --quiet

if [ $? -ne 0 ]; then
  log_error "Deployment failed"
  exit 1
fi

# Push to git repository
log_info "ğŸ“¤ Pushing to git repository..."
git push

log_success "Complete workflow successful!"
log_success "ğŸŒ Function deployed to Google Cloud Functions"
