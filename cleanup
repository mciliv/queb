#!/bin/bash

# Load shared colors and logging functions
source infrastructure/scripts/colors.sh

log_clean "Cleaning up all development processes and ports..."

# Kill all Node.js processes related to our project
pkill -f "node.*backend/api/server.js" 2>/dev/null || true
pkill -f "nodemon.*backend/api/server.js" 2>/dev/null || true
pkill -f "npm.*nodemon" 2>/dev/null || true

# Kill any remaining nodemon processes
pkill -f "nodemon" 2>/dev/null || true

# Kill Node.js development processes
pkill -f "backend/api/server.js" 2>/dev/null || true

# Kill our file watcher processes (legacy)
if [ -f /tmp/dev_watcher_pid ]; then
    WATCHER_PID=$(cat /tmp/dev_watcher_pid)
    kill $WATCHER_PID 2>/dev/null || true
    rm -f /tmp/dev_watcher_pid
fi

# Kill dev browser manager if running
if [ -f /tmp/dev_browser_pid ]; then
    B_PID=$(cat /tmp/dev_browser_pid)
    kill $B_PID 2>/dev/null || true
    rm -f /tmp/dev_browser_pid
fi

# Kill our reload server (legacy)
if [ -f /tmp/dev_reload_pid ]; then
    RELOAD_PID=$(cat /tmp/dev_reload_pid)
    kill $RELOAD_PID 2>/dev/null || true
    rm -f /tmp/dev_reload_pid
fi

# Kill any fswatch processes (legacy)
pkill -f "fswatch" 2>/dev/null || true

# Try to free up the common ports
if command -v lsof >/dev/null 2>&1; then
  for port in 3000 3001 3002 3004; do
    pids=$(lsof -ti:$port 2>/dev/null || true)
    if [ ! -z "$pids" ]; then
      log_info "ðŸ”„ Freeing port $port (PIDs: $pids)..."
      echo "$pids" | xargs kill -9 2>/dev/null || true
    fi
  done
fi

# Clean up temp files
rm -f /tmp/dev_backend_pid

rm -f /tmp/dev_server_pid
rm -f /tmp/frontend_last_check

# Remove temporary Chrome user data directories created by helpers
ROOT_DIR="$(cd "$(dirname "$0")" && pwd)"
TEST_DIR="$ROOT_DIR/test"
if [ -d "$TEST_DIR" ]; then
  rm -rf "$TEST_DIR"/chrome-molecular-profile-* 2>/dev/null || true
  rm -rf "$TEST_DIR"/seamless-chrome-profile 2>/dev/null || true
  rm -rf "$TEST_DIR"/single-tab-chrome 2>/dev/null || true
fi

# Wait a moment for processes to fully terminate
sleep 1

log_success "Cleanup complete. You can now restart the server." 