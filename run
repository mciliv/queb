#!/bin/bash

case "$1" in
  # Development
  "dev"|"start")
    echo "ğŸš€ Starting development server..."
    pkill -f "node.*backend/api/server.js" 2>/dev/null || true
    pkill -f "nodemon" 2>/dev/null || true
    sleep 1
    npx jest --testPathPattern=unit.test.js --verbose --silent && nodemon backend/api/server.js
    ;;
  "server")
    echo "ğŸš€ Starting production server..."
    pkill -f "node.*backend/api/server.js" 2>/dev/null || true
    sleep 1
    node backend/api/server.js
    ;;
  "debug")
    echo "ğŸ› Starting server with debugger..."
    pkill -f "node.*backend/api/server.js" 2>/dev/null || true
    sleep 1
    node --inspect backend/api/server.js
    ;;
  
  # Testing
  "test")
    echo "ğŸ§ª Running tests..."
    npx jest --testPathPattern=unit.test.js --verbose --silent && npx jest --testPathPattern=integration.test.js --verbose
    ;;
  "test:unit")
    echo "ğŸ§ª Running unit tests..."
    npx jest --testPathPattern=unit.test.js --verbose --silent
    ;;
  "test:integration")
    echo "ğŸ§ª Running integration tests..."
    npx jest --testPathPattern=integration.test.js --verbose
    ;;
  "test:connections")
    echo "ğŸ”— Testing backwards connections..."
    npx jest test/backwards-connection.test.js --verbose
    ;;
  
  # Utilities
  "format")
    echo "ğŸ¨ Formatting code..."
    prettier --write .
    ;;
  "clean")
    echo "ğŸ§¹ Cleaning up..."
    ./cleanup
    ;;
  "deploy")
    echo "ğŸš€ Deploying..."
    ./ship
    ;;
  
  # Help
  "help"|"--help"|"-h"|"")
    echo "Commands:"
    echo "  dev              - Start development server"
    echo "  server           - Start production server"  
    echo "  debug            - Start with debugger"
    echo "  test             - Run tests"
    echo "  test:connections - Test backwards endpoint connections"
    echo "  format           - Format code"
    echo "  clean            - Clean up processes"
    echo "  deploy           - Deploy to production"
    ;;
  *)
    echo "âŒ Unknown command: $1"
    echo "Run './run help' for available commands"
    exit 1
    ;;
esac 