#!/bin/bash

case "$1" in
  # Development
  "dev"|"start")
    echo "ğŸ§¹ Cleaning up any existing development processes..."
    # Kill any existing node processes running our server
    pkill -f "node.*backend/api/server.js" 2>/dev/null || true
    pkill -f "nodemon" 2>/dev/null || true
    
    # Wait a moment for cleanup
    sleep 1
    
    echo "ğŸš€ Starting development server..."
    npx jest --testPathPattern=unit.test.js --verbose --silent && nodemon backend/api/server.js
    ;;
  "server")
    echo "ğŸ§¹ Cleaning up any existing server processes..."
    pkill -f "node.*backend/api/server.js" 2>/dev/null || true
    sleep 1
    echo "ğŸš€ Starting production server..."
    node backend/api/server.js
    ;;
  "debug")
    echo "ğŸ§¹ Cleaning up any existing debug processes..."
    pkill -f "node.*backend/api/server.js" 2>/dev/null || true
    sleep 1
    echo "ğŸ› Starting server with debugger..."
    node --inspect backend/api/server.js
    ;;
  "unsafe")
    echo "ğŸ§¹ Cleaning up any existing processes..."
    pkill -f "node.*backend/api/server.js" 2>/dev/null || true
    pkill -f "nodemon" 2>/dev/null || true
    sleep 1
    echo "ğŸš€ Starting unsafe development server (no tests)..."
    nodemon backend/api/server.js
    ;;
  
  # Testing
  "test")
    echo "ğŸ§ª Running test suite..."
    npx jest --testPathPattern=unit.test.js --verbose --silent && npx jest --testPathPattern=integration.test.js --verbose && npx jest --testPathPattern=system.test.js --verbose --detectOpenHandles
    ;;
  "test:unit")
    echo "ğŸ§ª Running unit tests..."
    npx jest --testPathPattern=unit.test.js --verbose --silent
    ;;
  "test:integration")
    echo "ğŸ§ª Running integration tests..."
    npx jest --testPathPattern=integration.test.js --verbose
    ;;
  "test:system")
    echo "ğŸ§ª Running system tests..."
    npx jest --testPathPattern=system.test.js --verbose --detectOpenHandles
    ;;
  "test:python")
    echo "ğŸ§ª Running Python tests..."
    python -m pytest test/ -v
    ;;
  "test:accuracy")
    echo "ğŸ§ª Running molecular accuracy tests..."
    node test/run-accuracy-tests.js
    ;;
  "test:all")
    echo "ğŸ§ª Running complete test suite..."
    npx jest --testPathPattern=unit.test.js --verbose --silent && npx jest --testPathPattern=integration.test.js --verbose && npx jest --testPathPattern=system.test.js --verbose --detectOpenHandles && python -m pytest test/ -v
    ;;
  
  # Utilities
  "format")
    echo "ğŸ¨ Formatting code..."
    prettier --write .
    ;;
  "clean")
    echo "ğŸ§¹ Cleaning up..."
    ./cleanup
    ;;
  "deploy")
    echo "ğŸš€ Deploying to production..."
    ./ship
    ;;
  "setup")
    echo "âš™ï¸ Setting up project..."
    ./infrastructure/scripts/setup-database.sh
    ;;
  "cert")
    echo "ğŸ” Generating certificates..."
    ./infrastructure/scripts/trust-cert.sh
    ;;
  
  # Frontend utilities  
  "build")
    echo "ğŸ—ï¸ Building frontend..."
    node frontend/build-frontend.js
    ;;
  "browser")
    echo "ğŸŒ Opening development browser..."
    node frontend/dev-browser.js
    ;;
  
  # Script runner - find and run scripts in their directories
  "run")
    if [ -z "$2" ]; then
      echo "Usage: ./run run <script-name> [args...]"
      exit 1
    fi
    shift # Remove 'run' command
    ./scripts/run "$@"
    ;;
  
  # Help
  "help"|"--help"|"-h"|"")
    echo "ğŸ”§ Available commands:"
    echo ""
    echo "Development:"
    echo "  dev, start    - Start development server with tests"
    echo "  server        - Start production server"
    echo "  debug         - Start server with debugger"
    echo "  unsafe        - Start development server without tests"
    echo ""
    echo "Testing:"
    echo "  test          - Run main test suite"
    echo "  test:unit     - Run unit tests only"
    echo "  test:integration - Run integration tests only"
    echo "  test:system   - Run system tests only"
    echo "  test:python   - Run Python tests only"
    echo "  test:accuracy - Run molecular accuracy tests"
    echo "  test:all      - Run complete test suite"
    echo ""
    echo "Frontend:"
    echo "  build         - Build frontend bundle"
    echo "  browser       - Open development browser"
    echo ""
    echo "Utilities:"
    echo "  format        - Format code with prettier"
    echo "  clean         - Clean up processes"
    echo "  deploy        - Deploy to production"
    echo "  setup         - Setup database"
    echo "  cert          - Generate certificates"
    echo "  run <script>  - Run script from its directory"
    echo "  help          - Show this help"
    echo ""
    echo "Examples:"
    echo "  ./run dev              # Start development server"
    echo "  ./run test:unit        # Run unit tests"
    echo "  ./run deploy           # Deploy to production"
    ;;
  *)
    echo "âŒ Unknown command: $1"
    echo "Run './run help' for available commands"
    exit 1
    ;;
esac 