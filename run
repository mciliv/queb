#!/usr/bin/env zsh
set -eo pipefail

PROJECT_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

start() {
  kill_port 8080
  
  # Check if bundle exists, build if missing
  if [ ! -f "$PROJECT_ROOT/src/client/dist/bundle.js" ]; then
    echo "ðŸ“¦ Building frontend bundle..."
    node "$PROJECT_ROOT/src/client/build-frontend.js" --quiet
  fi
  
  node "$PROJECT_ROOT/src/server/api/server.js"
}

kill_port() {
  local port="${1:-8080}"
  if lsof -ti:$port >/dev/null 2>&1; then
    lsof -ti:$port | xargs kill -9 2>/dev/null || true
  fi
}

wait_for_server() {
  # Poll health endpoint until server responds or timeout hits
  local max_attempts=30
  local attempt=0
  
  while [ $attempt -lt $max_attempts ]; do
    if curl -s "http://localhost:8080/health" > /dev/null 2>&1; then
      return 0
    fi
    attempt=$((attempt + 1))
    sleep 1
  done
  
  return 1
}

deploy() {
  local env="${1:-dev}"
  if [[ "$env" != "dev" && "$env" != "prod" ]]; then
    echo "Usage: ./run deploy [dev|prod]" >&2
    echo "  dev  - Deploy to dev.queb.space" >&2
    echo "  prod - Deploy to queb.space" >&2
    return 1
  fi
  "$PROJECT_ROOT/deploy/deploy.sh" "$env"
}

build() { 
  node "$PROJECT_ROOT/src/client/build-frontend.js"
}

dev() {
  # Start watch mode in background
  echo "ðŸ”„ Starting frontend watch mode..."
  node "$PROJECT_ROOT/src/client/build-frontend.js" --watch --quiet &
  local watch_pid=$!
  
  # Start server
  kill_port 8080
  node "$PROJECT_ROOT/src/server/api/server.js" &
  local server_pid=$!
  
  # Cleanup on exit
  trap "kill $watch_pid $server_pid 2>/dev/null || true" EXIT
  wait $server_pid
}

debug() {
  kill_port 8080
  node --inspect "$PROJECT_ROOT/src/server/api/server.js"
}

debug-brk() {
  kill_port 8080
  node --inspect-brk "$PROJECT_ROOT/src/server/api/server.js"
}

browser() {
  kill_port 8080
  node "$PROJECT_ROOT/src/server/api/server.js" &
  sleep 3 # make next line run when server.js has run to appropriate point instead
  open "http://localhost:8080"
  wait
}

test-inject() {
  local test_case="${1:-coffee}"
  kill_port 8080
  node "$PROJECT_ROOT/src/server/api/server.js" &
  local server_pid=$!
  sleep 4
  if ! curl -s "http://localhost:8080/health" > /dev/null; then
    echo "âŒ Server failed to start"
    kill $server_pid 2>/dev/null || true
    exit 1
  fi
  
  node "$PROJECT_ROOT/scripts/inject-test.js" "$test_case"
  open "http://localhost:8080"
  wait $server_pid
}

test-dev() {
  local test_case="${1:-coffee}"
  kill_port 8080
  AUTO_TEST_INJECT="$test_case" node "$PROJECT_ROOT/src/server/api/server.js" &
  local server_pid=$!
  
  sleep 3
  open "http://localhost:8080"
  wait $server_pid
}

after-agent-change() {
  echo "ðŸ§ª Running all tests..."
  if ! npm run test:all; then
    echo "âŒ Tests failed. Not starting server."
    return 1
  fi

  echo ""
  echo "âœ… All tests passed!"
  echo ""
  echo "ðŸš€ Starting server and opening browser..."

  kill_port 8080
  node "$PROJECT_ROOT/src/server/api/server.js" &
  local server_pid=$!

  if wait_for_server; then
    echo "âœ… Server is ready"
    open "http://localhost:8080"
    echo "ðŸŒ Browser opened at http://localhost:8080"
    echo ""
    echo "Press Ctrl+C to stop the server"
    wait $server_pid
  else
    echo "âŒ Server failed to start within 30 seconds"
    kill $server_pid 2>/dev/null || true
    return 1
  fi
}

CMD="${1:-start}"
if [[ "$CMD" == "-h" || "$CMD" == "--help" ]]; then
  help
  exit 0
fi
shift || true
"$CMD" "$@"