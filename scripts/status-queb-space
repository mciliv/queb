#!/bin/bash

# Status Queb.Space - Environment Status Check
# ===========================================
# Checks status of both queb.space and dev.queb.space environments

set -e

# Colors and tiny log helpers
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'
log_info() { echo -e "${BLUE}â„¹ï¸  $1${NC}"; }
log_success() { echo -e "${GREEN}âœ… $1${NC}"; }
log_warning() { echo -e "${YELLOW}âš ï¸  $1${NC}"; }
log_error() { echo -e "${RED}âŒ $1${NC}"; }

# Get project root
PROJECT_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$PROJECT_ROOT"

echo "ðŸ” Queb.Space Status Check"
echo "========================="
echo ""

# Check local development environment
echo "ðŸ  Local Development (localhost)"
echo "-------------------------------"

# Check .env file
if [ -f ".env" ]; then
    log_success ".env file exists"
else
    log_error ".env file missing"
fi

# Check SSL certificates
if [ -f "backend/api/certs/cert.pem" ] && [ -f "backend/api/certs/key.pem" ]; then
    log_success "SSL certificates exist"
else
    log_error "SSL certificates missing"
fi

## Hosts entry no longer required
log_success "Using localhost (no hosts entry needed)"

# Check Node.js server
if pgrep -f "node.*server.js" > /dev/null; then
    log_success "Node.js server is running"
else
    log_warning "Node.js server is not running"
fi

echo "DNS: localhost always resolves"

echo ""

# Check Google Cloud environment
echo "â˜ï¸ Google Cloud (queb.space)"
echo "---------------------------"

# Check if gcloud is installed
if command -v gcloud >/dev/null 2>&1; then
    log_success "gcloud CLI installed"
else
    log_error "gcloud CLI not installed"
    echo ""
    echo "ðŸ“‹ Local Development Status Summary:"
    echo "   Run: ./setup-queb-space.sh (option 1)"
    echo "   Start: ./dev-queb-space"
    exit 0
fi

# Check authentication
if gcloud auth list --filter=status:ACTIVE --format="value(account)" | grep -q .; then
    log_success "Google Cloud authenticated"
    gcloud auth list --filter=status:ACTIVE --format="value(account)" | sed 's/^/   /'
else
    log_error "Google Cloud not authenticated"
fi

# Check project
CURRENT_PROJECT=$(gcloud config get-value project 2>/dev/null)
if [ "$CURRENT_PROJECT" = "molecular-analysis" ]; then
    log_success "Project set to molecular-analysis"
else
    log_warning "Project set to: $CURRENT_PROJECT"
fi

# Check DNS zone
if gcloud dns managed-zones describe queb-space-zone --format="value(name)" 2>/dev/null; then
    log_success "DNS zone exists"
    
    # Show nameservers
    echo "   Nameservers:"
    gcloud dns managed-zones describe queb-space-zone --format="value(nameServers)" | tr ';' '\n' | sed 's/^/     /'
else
    log_error "DNS zone missing"
fi

# Check Cloud Function
if gcloud functions describe molecular-analysis --region=us-central1 --format="value(status)" 2>/dev/null; then
    FUNCTION_STATUS=$(gcloud functions describe molecular-analysis --region=us-central1 --format="value(status)")
    if [ "$FUNCTION_STATUS" = "ACTIVE" ]; then
        log_success "Cloud Function is ACTIVE"
        
        # Get function URL
        FUNCTION_URL=$(gcloud functions describe molecular-analysis --region=us-central1 --format="value(serviceConfig.uri)")
        echo "   Function URL: $FUNCTION_URL"
        
        # Test function
        if curl -s -f "$FUNCTION_URL" > /dev/null 2>&1; then
            log_success "Function responds to requests"
        else
            log_warning "Function does not respond to requests"
        fi
    else
        log_warning "Cloud Function status: $FUNCTION_STATUS"
    fi
else
    log_error "Cloud Function not found"
fi

# Check domain mappings
echo ""
echo "ðŸ”— Domain Mappings:"

if gcloud beta run domain-mappings describe --service=molecular-analysis --domain=queb.space --region=us-central1 --format="value(status)" 2>/dev/null; then
    MAPPING_STATUS=$(gcloud beta run domain-mappings describe --service=molecular-analysis --domain=queb.space --region=us-central1 --format="value(status)")
    if [ "$MAPPING_STATUS" = "ACTIVE" ]; then
        log_success "queb.space mapping: ACTIVE"
    else
        log_warning "queb.space mapping: $MAPPING_STATUS"
    fi
else
    log_error "queb.space mapping: Not found"
fi

if gcloud beta run domain-mappings describe --service=molecular-analysis --domain=www.queb.space --region=us-central1 --format="value(status)" 2>/dev/null; then
    MAPPING_STATUS=$(gcloud beta run domain-mappings describe --service=molecular-analysis --domain=www.queb.space --region=us-central1 --format="value(status)")
    if [ "$MAPPING_STATUS" = "ACTIVE" ]; then
        log_success "www.queb.space mapping: ACTIVE"
    else
        log_warning "www.queb.space mapping: $MAPPING_STATUS"
    fi
else
    log_error "www.queb.space mapping: Not found"
fi

# Test domain resolution
echo ""
echo "ðŸŒ Domain Resolution:"

if nslookup queb.space > /dev/null 2>&1; then
    log_success "queb.space resolves"
else
    log_warning "queb.space does not resolve"
fi

if nslookup www.queb.space > /dev/null 2>&1; then
    log_success "www.queb.space resolves"
else
    log_warning "www.queb.space does not resolve"
fi

echo ""
echo "ðŸ“‹ Summary:"
echo "==========="

# Local development summary
if [ -f ".env" ] && [ -f "backend/api/certs/cert.pem" ]; then
    log_success "Local development ready"
    echo "   Start: ./dev-queb-space"
else
    log_warning "Local development needs setup"
    echo "   Setup: ./setup-queb-space.sh (option 1)"
fi

# Production summary
if command -v gcloud >/dev/null 2>&1 && \
   gcloud auth list --filter=status:ACTIVE --format="value(account)" | grep -q . && \
   gcloud functions describe molecular-analysis --region=us-central1 --format="value(status)" 2>/dev/null | grep -q "ACTIVE"; then
    log_success "Production ready"
    echo "   Deploy: ./deploy-queb-space"
else
    log_warning "Production needs setup"
    echo "   Setup: ./setup-queb-space.sh (option 2 or 3)"
fi
