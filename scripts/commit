#!/bin/bash
# Usage: ./commit [message]

set -e

# Get project root
PROJECT_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$PROJECT_ROOT"

# Colors for output
source infrastructure/scripts/colors.sh

# Check if there are changes
if [[ -z $(git status --porcelain) ]]; then
    log_info "No changes to commit"
    exit 0
fi

# Add all changes
git add .

# Use provided message or generate one
if [ -n "$1" ]; then
    COMMIT_MSG="$*"
else
    COMMIT_MSG=$(node generate-commit-message.js 2>/dev/null || echo "chore: update files")
fi

git status --short
echo "Message: $COMMIT_MSG"

# Ask for confirmation
read -p "Proceed with commit and push? (y/n/e to edit message): " -n 1 -r
echo ""

if [[ $REPLY =~ ^[Yy]$ ]]; then
    git commit -m "$COMMIT_MSG"
    git push
elif [[ $REPLY =~ ^[Ee]$ ]]; then
    read -p "Enter commit message: " CUSTOM_MSG
    git commit -m "$CUSTOM_MSG"
    git push
else
    git reset HEAD
fi

